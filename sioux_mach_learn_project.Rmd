---
output:
  bookdown::pdf_document2:
    includes:
      in_header: latex/preamble.tex
      before_body: latex/titlepage.tex
    pandoc_args:
    - --csl
    - references/apa.csl
  bookdown::html_document2:
    pandoc_args:
    - --csl
    - references/apa.csl
  bookdown::word_document2:
    pandoc_args:
    - --csl
    - references/apa.csl
toc-title: Table of Contents
bibliography: references/references.bib
link-citations: yes
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \renewcommand{\headrulewidth}{0pt}
- \fancyfoot[C]{}
- \fancyfoot[R]{\thepage}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, messages = FALSE)
packages <- c("dplyr","readxl", "curl", "ggplot2", "ggrepel", "maps", "plotly", "stringr", "tm", "wordcloud2", "tidyverse", "RColorBrewer", "ggwordcloud", "viridis", "bookdown", "utils", "leaps", "broom","GGally", "e1071", "caret")
package.check <- lapply(packages, FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
        install.packages(x, dependencies = TRUE)
        library(x, character.only = TRUE)
    }
})
```

\fancyhead[LR]{}
\pagenumbering{roman}

\newpage
\cleardoublepage
\pagenumbering{arabic}
\fancyhead[L]{Applied Machine Learning and Predictive Modelling: Stroke Data}
\fancyhead[R]{MPM02}


# Introduction
Use case:
We are a smart watch manufacturer working on a new feature for stroke prevention.
We are going to analyze survey data that we plan to ask our users, complementing it with HR (Heart Rate) and CGM (Continuous Glucose Monitoring) data that our product already measures.
We hope that our feature can prevent serious health issues and motivate our users to adopt healthier lifestyles.

# Importing Data


````{r raw_data_view}
stroke_data <- read_csv('./data/healthcare-dataset-stroke-data.csv')
s <- spec(stroke_data)
s

cols_condense(s)
stroke_data$bmi <- as.numeric(stroke_data$bmi)
stroke_data$bmi[is.na(stroke_data$bmi)] <- mean(stroke_data$bmi, na.rm = TRUE)
stroke_data$stroke <- as.factor(stroke_data$stroke)
stroke_data$age <- as.integer(stroke_data$age)
stroke_data$smoking_status <- as.factor(stroke_data$smoking_status)
stroke_data$work_type <- as.factor(stroke_data$work_type)
stroke_data$gender <- as.factor(stroke_data$gender)
stroke_data$ever_married <- as.factor(stroke_data$ever_married)
stroke_data$Residence_type <- as.factor(stroke_data$Residence_type)


stroke_data

````
## Summaries
```{r}
#testing the effect of non smokers and smokers
count_by_smoke_status <- stroke_data %>% 
  select(smoking_status, stroke) %>%
  group_by(smoking_status, stroke) %>%
  summarise( N = n())

```
```{r}
#testing the effect of work type
 count_by_work_type <- stroke_data %>% 
   select(work_type, stroke) %>% 
   group_by(work_type, stroke) %>%
   summarise( N = n())
```
```{r}
 # testing the effects of residence type
count_by_Residence_type <- stroke_data %>% 
   select(Residence_type, stroke) %>% 
   group_by(Residence_type, stroke) %>%
   summarise( N = n())
```
```{r}
 # testing the effects of gender
count_by_gender <- stroke_data %>% 
   select(gender, stroke) %>% 
   group_by(gender, stroke) %>%
   summarise( N = n())

```
```{r}
 # testing the effects of hypertension
count_by_hypertension <- stroke_data %>% 
   select(hypertension, stroke) %>% 
   group_by(hypertension, stroke) %>%
   summarise( N = n())

```
```{r}
# testing the effects of heart disease
count_by_heart_disease <- stroke_data %>% 
   select(heart_disease, stroke) %>% 
   group_by(heart_disease, stroke) %>%
   summarise( N = n())
```
```{r}
# testing the effects of marriage status
count_by_marriage <- stroke_data %>% 
   select(ever_married, stroke) %>% 
   group_by(ever_married, stroke) %>%
   summarise( N = n())
```







## Scatterplots
```{r scatterplots}
stroke_data %>% 
  ggplot(mapping = aes(x = bmi, y = age, color = stroke)) +
  geom_point() +
  geom_smooth(method = 'lm')

stroke_data %>% 
  filter(stroke == 1) %>%
  ggplot(mapping = aes(x = bmi, y = age, color = smoking_status)) +
  geom_point(method = 'lm') +
  geom_smooth(method = 'lm')

stroke_data %>% 
  ggplot(mapping = aes(x = bmi, y = avg_glucose_level, color = stroke)) +
  geom_point() +
  geom_smooth(method = 'lm')

stroke_data %>% 
  filter(stroke == 1) %>%
  ggplot(mapping = aes(x = bmi, y = avg_glucose_level, color = stroke)) +
  geom_point(method = 'lm') +
  geom_smooth(method = 'lm')
```

## Boxplots

```{r boxplot_gluc}
#Boxplot on avg. glucose_level
ggplot(stroke_data, aes(y = avg_glucose_level)) +
  geom_boxplot()
```

```{r}
#Boxplot on Age 
ggplot(stroke_data, aes(y = age)) +
  geom_boxplot() 
```

```{r}
stroke_by_age <- stroke_data %>%
# dplyr::filter(stroke == 1) %>%
 ggplot(aes(x = stroke,
            y = age)) +
  geom_boxplot() +
  labs(title = "Boxplot on no-Stroke (0) and Stroke (1) by Age",
       x = "No-stroke (0) and Stroke (1)",
       y = "Age")
       color = "green"

stroke_by_age 
```




```{r}
#Boxplot on BMI
ggplot(stroke_data, aes(y = bmi)) +
geom_boxplot()
```

```{r}
stroke_by_bmi <- stroke_data %>%
# dplyr::filter(stroke == 1) %>%
 ggplot(aes(x = stroke,
            y = bmi)) +
  geom_boxplot(color="orange", fill="yellow", alpha=0.2) +
  ggtitle("BMI by Stroke") + 
  xlab("Stroke") + ylab("BMI") +
  theme_minimal() + theme(axis.text.x = element_text(angle = 0))
stroke_by_bmi
```


```{r}
#boxplot by avg_glucose_level and stroke
stroke_by_avg_glucose_level <- stroke_data %>%
# dplyr::filter(stroke == 1) %>%
 ggplot(aes(x = stroke,
            y = avg_glucose_level)) +
  geom_boxplot(color="orange", fill="yellow", alpha=0.2) +
  ggtitle("Average Glucose Level by Stroke") + 
  xlab("Stroke") + ylab("Avg. Glucose Level") +
  theme_minimal() + theme(axis.text.x = element_text(angle = 0))

stroke_by_avg_glucose_level

```


# Methodology

```{r}
set.seed(7406)
n=dim(stroke_data[1])  # number of observations in dataset
n_train=0.70*n  # training set is 70%
flag = sort(sample(1:n, size=n_train, replace=FALSE))
```
```{r}
# Use df (all data points without ID column) df_train, and df_test
# Gender, hypertension, heart disease, ever married, work type, residence type, smoking status, and stroke are all factor types.
# This should allow for the best modeling options possible for our methods.
df_train = stroke_data[flag,]
df_test = stroke_data[-flag,]
```

```{r}
head(df_test)
head(df_train)
```


# Linear Model
```{r}
# qplot -> age/glucose level per stroke
library(ggplot2)
 qplot(y = age, x = avg_glucose_level,
        data = stroke_data,
        facets = ~ stroke)
```
```{r}
# fitting models for simple regression model
 lm.stroke <- lm(age ~ avg_glucose_level, data = stroke_data)
 summary(lm.stroke)
```

```


# Generalised Linear Model with family set to Poisson

```{r}
glm.stroke <- glm(age ~ smoking_status,
family = "poisson",
data = stroke_data)
summary(glm.stroke)
```


```{r}
#glm.stroke <- glm(bmi ~ stroke,
#family = "poisson",
#data = stroke_data)
#summary(glm.stroke)
```

```{r}

```

# Generalised Linear Model with family set to Binomial Fabian

# Generalised Additive Model Fabian

# Neural Network Yves 

# Support Vector Machine (Larissa)

Stroke Data Classification using a Support Vector Machine.

```{r}
ytrain = df_train$stroke
ytest = df_test$stroke
```
 
```{r}
svm_model <- svm(stroke ~. , data = df_train, type = "C-classification", kernel = "radial", cost = "5")
summary(svm_model)
plot(svm_model, data = df_train, bmi ~ age, slice = list(avg_glucose_level = 3))
```

```{r}
#svm_training_prediction <- predict(svm_model, newdata = df_train)
#svm_training_error <- mean(svm_training_prediction != ytrain)
#draw_confusion_matrix(confusionMatrix(svm_training_prediction,df_train$stroke), "Stroke", "No Stroke")
#svm_training_error
#confusionMatrix(svm_training_prediction,df_train$stroke)
```


```{r}
#svm_prediction <- predict(svm_model, newdata = df_test)
#svm_test_error <- mean(svm_prediction != ytest)
#draw_confusion_matrix(confusionMatrix(svm_prediction,df_test$stroke), "Stroke", "No Stroke")
#svm_test_error
```


# OPTIONAL solve an optimisation problem


\newpage
